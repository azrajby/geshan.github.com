<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>How to Use Docker Compose With Virtual Hosts and Shared Services (Like Db) for Dev Environment - Geshan&#8217;s Blog</title>
  <meta name="author" content="Geshan Manandhar">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://geshan.com.np/blog/2017/05/how-to-use-docker-compose-with-virtual-hosts-and-services-like-db-for-dev-environment">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Geshan's Blog" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://geshan.com.np/blog/2017/05/how-to-use-docker-compose-with-virtual-hosts-and-services-like-db-for-dev-environment">
  <meta property="og:title" content="How to Use Docker Compose With Virtual Hosts and Shared Services ( &hellip; - Geshan's Blog">
  

  <link href="/assets/bootstrap/dist/css/bootstrap.united.min.css" rel="stylesheet" type="text/css">

<meta property="og:image:width" content="450"/>
<meta property="og:image:height" content="298"/>
<meta name="p:domain_verify" content="e654c68562abebfa25c291f59d7d00e8"/>


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-56310304-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Geshan&#8217;s Blog</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="geshan.com.np" />
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-8" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Geshan's Blog" />
    <meta itemprop="description" content="A blog about technology, open source, web development etc." />
    <meta itemprop="url" content="http://geshan.com.np" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2017-05-25T00:53:04+10:00"  data-updated="true" itemprop="datePublished dateCreated"><time class='entry-date' datetime='2017-05-25T00:53:04+10:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>12:53 am</span></time></time>
        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        How to Use Docker Compose With Virtual Hosts and Shared Services (Like Db) for Dev Environment
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody description"><p>Docker as been immensely popular in the past years. If you are not using docker at least in your dev environment in 2017.
You are surely missing out on some great advantages. Your new software engineer should start writing production-ready code
in a matter of hours not days. All thanks to docker.  Along the same lines, this post will cover how you can set up
docker for your dev environment with least friction and maximum productivity. It is an opinionated post. We migrated to this <code>external_links</code>
<a href="https://docs.docker.com/compose/compose-file/#externallinks">approach</a> so that we could run multiple projects/microservices that use the same db/services shared among them.</p>

<p><img class="center" src="/images/docker-compose-vhost/docker-compose-vhost.jpg" title="Docker compose with vhost and shared services" alt="Docker compose with vhost and shared services"></p>

<!-- more -->


<h2>Context</h2>

<ul>
<li>This tutorial is generally agnostic of docker and docker-compose versions (I am using docker compose 1 syntax). I assume you have docker and docker-compose installed and know about them.</li>
<li>It uses external images like Nginx proxy for virtual host per project. Mysql db as shared external service. It could also have been mongo or redis or even rabbit mq. The main point is to use it as <code>external_link</code> in the docker compose file, so that it can be shared among projects.</li>
<li>It uses a demo app which emulates the page visit/hit counter popular decades back with a <a href="https://github.com/geshan/counter/blob/master/index.js">~30 liner Nodejs app</a> and Mysql db.</li>
<li>I would like to keep the description as concise as possible and in points to make it simple and clear. You should read the code of <a href="https://github.com/geshan/counter">sample counter project</a> and sample mysql container&rsquo;s <a href="https://github.com/geshan/sample-mysql/blob/master/docker-compose.yml">docker-compose.yml</a> well.</li>
<li>The goal is to grasp the concepts well and apply it to your current project. For example, you could start with replacing your local mysql install with a docker container.</li>
</ul>


<h2>Problems to solve</h2>

<ol>
<li>After I use docker and docker compose, the web server (nginx/apache etc) of project A takes up port 80 and I can&rsquo;t run project B on port 80 or have a virtual host for both projects.</li>
<li>When I use my db (mysql/postgres) as a service in my docker compose for project A, It is cumbersome to use the same db for another project as its coupled with project A.</li>
<li>I just want to run my mysql database, import some data and run some queries. I don&rsquo;t want to run my app for now.</li>
</ol>


<h2>Solution goals</h2>

<ol>
<li>To make services like db etc independent of projects and shared among projects similar to having a local install of mysql with multiple databases.</li>
<li>Multiple projects should be able to run in parallel and each of them will have their own virtual host for easy accessibility.</li>
</ol>


<h2>Steps</h2>

<ol>
<li>Run the Nginx proxy to enable virtual hosts with <code>$ docker run -d -p 80:80 -v /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy</code></li>
<li>Add <code>127.0.0.1 counter.local.dev</code> to your hosts file (on unix based system it is <code>/etc/hosts</code> file)</li>
<li>Create an empty folder db in your home (<code>~/db</code>), to save your mysql data</li>
<li>Clone mysql repo from <a href="https://github.com/geshan/sample-mysql">here</a> maybe at <code>~/projects/mysql</code></li>
<li>In <code>~/projects/mysql</code> run docker-compose up to run mysql, it will create <a href="https://github.com/geshan/sample-mysql/blob/master/init-dump/counter.sql">counter db, counts table with one row</a>.</li>
<li>Clone the sample counter app from <a href="https://github.com/geshan/counter">here</a> to maybe <code>~/projects/counter</code>.</li>
<li>In <code>~/projects/counter</code> run <code>docker-compose up</code></li>
<li>Then go to <code>http://counter.local.dev</code> on your browser you should see <code>Page visited 1 times</code>, refresh it, it should say <code>Page visited 2 times</code></li>
</ol>


<p><img class="center" src="/images/docker-compose-vhost/page-visited.png" title="All working you should see this" alt="All working you should see this"></p>

<p>Virtual host has been possible in above setup as we ran the nginx proxy and configured <code>VIRTUAL_HOST</code> and <code>VIRTUAL_PORT</code> parameters correctly
in the docker-compose.yml of the sample counter project. Mysql was already running before the project even started to run and it was <code>external_links</code>,
the IP of the mysql container was automatically added to the <code>/etc/hosts</code> of the counter project container which enabled us to use the host for mysql db
as <a href="https://github.com/geshan/counter/blob/master/index.js#L4">mysql</a> in the connection config we passed to the mysql library.</p>

<p>Steps for running dependent services like nginx proxy, mysql can surely be automated for speed and efficiency.</p>

<h2>Takeaways</h2>

<ol>
<li>You can plan a step by step migration like first get your db/queue migrated from local install to docker then the app.</li>
<li>Use <code>external_links</code> for all the services like db/queue/redis/solr anything that needs to be shared among projects.</li>
<li>Use <a href="https://github.com/jwilder/nginx-proxy">nginx proxy</a> to enable virtual host per project with two simple env variables <code>VIRTUAL_HOST</code> and <code>VIRTUAL_PORT</code> in the project&rsquo;s <a href="https://github.com/geshan/counter/blob/master/docker-compose.yml#L8-L9">docker-compose</a> file. <code>VIRTUAL_PORT</code> is 8080 because application is <a href="https://github.com/geshan/counter/blob/master/index.js#L27">running</a> on port 8080 and same port is exposed from the <a href="https://github.com/geshan/counter/blob/master/Dockerfile#L10">dockerfile</a>.</li>
<li>Run all your dependencies before hand and then run <code>docker-compose up</code> on your project(s). Dependencies can be run with <code>docker-compose up -d</code> to put it in the background. You can use <code>docker-compose -f logs</code> to follow logs and check if the service is running fine.</li>
<li>In this way, you can run multiple projects sharing the same db instance and each project can have its own virtual host.</li>
</ol>


<blockquote><p>Hope you found this helpful. For more clarity, please read the <a href="https://github.com/geshan/counter/blob/master/Dockerfile">Dockerfile</a>, <a href="https://github.com/geshan/counter/blob/master/docker-compose.yml">docker-compose.yml</a> and <a href="https://github.com/geshan/counter/blob/master/index.js">index.js</a> of the sample counter project thoroughly.</p></blockquote>
</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person">Posted by <span class="fn" itemprop="name">Geshan Manandhar</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2017-05-25T00:53:04+10:00"  data-updated="true" itemprop="datePublished dateCreated"><time class='entry-date' datetime='2017-05-25T00:53:04+10:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>12:53 am</span></time></time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/devops/'>devops</a>, <a class='category' href='/blog/categories/docker/'>docker</a>, <a class='category' href='/blog/categories/misc/'>misc</a>, <a class='category' href='/blog/categories/technology/'>technology</a>
  
</span>


        </p>
        
          <div class='shareaholic-canvas' data-app='share_buttons' data-app-id='11665322'></div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/2017/02/things-i-wished-i-knew-as-a-junior-developer-slides/" title="Previous Post: Things I wished I knew as a junior developer for Developers Nepal Meetup #4 [Slides and Video]">&laquo; Things I wished I knew as a junior developer for Developers Nepal Meetup #4 [Slides and Video]</a></li>
            
            
            <li class="next"><a href="/blog/2017/06/software-companies-tech-competency-matrix/" title="Next Post: Software Companies Tech Competency Matrix">Software Companies Tech Competency Matrix &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
  </div>

  
  <aside class="sidebar col-md-4">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/2018/12/2018-in-review-5-most-viewed-posts-of-this-year/">2018 in Review: 5 Most Viewed Posts of This Year</a>
    
    <a class="list-group-item " href="/blog/2018/12/the-most-important-tip-for-beginner-software-engineers-is/">The Most Important Tip for Beginner Software Engineers Is&#8230;</a>
    
    <a class="list-group-item " href="/blog/2018/12/you-can-do-it-in-sql/">You Can Do It in SQL, Stop Writing Extra Code for That</a>
    
    <a class="list-group-item " href="/blog/2018/12/5-tech-medium-publications-software-engineers-should-strive-to-write-for/">5 Tech Medium Publications Software Engineers Should Strive to Write For</a>
    
    <a class="list-group-item " href="/blog/2018/12/4-ways-docker-changed-the-way-software-engineers-work-in-past-half-decade/">4 Ways Docker Changed the Way Software Engineers Work in Past Half Decade</a>
    
  </div>
</section>
<section class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">Categories</h3>
    </div>
    <div class="list-group">
        
        
        <a class="list-group-item " href="/blog/categories/misc/">
            <span class="badge">128</span>
            misc
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/mobiles/">
            <span class="badge">3</span>
            mobiles
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/technology/">
            <span class="badge">131</span>
            technology
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/foss/">
            <span class="badge">15</span>
            foss
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/drupal/">
            <span class="badge">37</span>
            drupal
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/programming/">
            <span class="badge">26</span>
            programming
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/tutorial/">
            <span class="badge">20</span>
            tutorial
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/learn-php/">
            <span class="badge">4</span>
            learn php
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/php/">
            <span class="badge">21</span>
            php
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/codeigniter/">
            <span class="badge">1</span>
            codeigniter
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/git/">
            <span class="badge">8</span>
            git
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/apps/">
            <span class="badge">4</span>
            apps
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/about-me/">
            <span class="badge">1</span>
            about me
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/android/">
            <span class="badge">2</span>
            android
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/infographics/">
            <span class="badge">7</span>
            infographics
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/testing/">
            <span class="badge">5</span>
            testing
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/javascript/">
            <span class="badge">1</span>
            javascript
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/symfony/">
            <span class="badge">3</span>
            symfony
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/talks/">
            <span class="badge">12</span>
            talks
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/devops/">
            <span class="badge">18</span>
            devops
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/laravel/">
            <span class="badge">2</span>
            laravel
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/deployment/">
            <span class="badge">6</span>
            deployment
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/logging/">
            <span class="badge">2</span>
            logging
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/api/">
            <span class="badge">1</span>
            api
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/docker/">
            <span class="badge">5</span>
            docker
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/database/">
            <span class="badge">1</span>
            database
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/microservice/">
            <span class="badge">1</span>
            microservice
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/agile/">
            <span class="badge">1</span>
            agile
        </a>
        
        
        <a class="list-group-item " href="/blog/categories/sql/">
            <span class="badge">1</span>
            sql
        </a>
        
    </div>
</section>
<section id="twitter-timeline" class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title">
            Latest Tweets
            
            <small class="pull-right">
              <a class="btn" href="//twitter.com/geshan" title="@geshan on Twitter" target="_blank">
                <i class="icon-external-link"></i>
              </a>
            </small>
            
        </h3>
    </div>
    <div class="list-group">
          <a class="twitter-timeline" data-dnt="true" href="//twitter.com/geshan"  data-widget-id="518273942725722112"  data-link-color="#049cdb" data-tweet-limit="" data-chrome="noheader nofooter transparent noscrollbar">Tweets by @geshan</a>
          <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </div>
</section>



    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2018 - Geshan Manandhar<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<!-- shareaholic start -->
<script type="text/javascript">
    //<![CDATA[
    (function() {
        var shr = document.createElement('script');
        shr.setAttribute('data-cfasync', 'false');
        shr.src = '//dsms0mj1bbhn4.cloudfront.net/assets/pub/shareaholic.js';
        shr.type = 'text/javascript'; shr.async = 'true';
        shr.onload = shr.onreadystatechange = function() {
            var rs = this.readyState;
            if (rs && rs != 'complete' && rs != 'loaded') return;
            var site_id = '053dbd80f9ee1f48b1d3735743458511';
            try { Shareaholic.init(site_id); } catch (e) {}
        };
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(shr, s);
    })();
    //]]>
</script>
<!-- shareaholic end -->
</footer>
    



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


  </body>
</html>
